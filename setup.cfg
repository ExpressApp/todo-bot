[tool:pytest]
testpaths = tests
addopts =
    --lf
    --diff-width=88
    --cov=app
    --cov=tests
    --no-cov-on-fail
    --cov-report term-missing
    --cov-fail-under=0

timeout = 20
filterwarnings =
    error

env =
    APP_ENV=test

[coverage:report]
precision = 2
exclude_lines =
    pragma: no cover
    raise NotImplementedError
    raise NotImplemented

[mypy]
disallow_untyped_defs = True
strict_optional = True
follow_imports = skip

[mypy-app.db.migrations.*]
ignore_errors = True

[mypy-mako.*]
ignore_missing_imports = True

[mypy-botx_metrics.*]
ignore_missing_imports = True

[mypy-sqlalchemy.*]
ignore_missing_imports = True

[mypy-alembic.*]
ignore_missing_imports = True

[mypy-loguru.*]
ignore_missing_imports = True

[mypy-prometheus_client.*]
ignore_missing_imports = True

[mypy-tortoise.*]
ignore_missing_imports = True

[mypy-aiofiles.*]
ignore_missing_imports = True

[mypy-asyncpg.*]
ignore_missing_imports = True

[isort]
multi_line_output = 3
include_trailing_comma = True
line_length = 88
force_grid_wrap = 0
combine_as_imports = True

[flake8]
# See https://flake8.pycqa.org/en/latest/user/configuration.html#project-configuration
max-line-length = 88
max-awaits = 10
max-local-variables = 10
max-module-members = 10
max-arguments = 10
nested-classes-whitelist = Config, Meta, Params
exclude = app/db/migrations
per-file-ignores =
# docstings for module
    */__init__.py:D104
    app/bot/commands/user/__init__.py:D104
    app/services/answers/__init__.py:D104
# upper-case constant in a class and docstring for module
    app/settings/environments/*.py:WPS115
    app/settings/environments/__init__.py:D104
# shadowing id
    app/db/tasks/models.py:WPS125
    app/schemas/task.py:WPS125
# allow many imports and many module members for handlers
    app/bot/commands/**/*.py:WPS201,WPS202,WPS235
# allow many module members and overused expression for answers builders and repo
    app/services/answers/*.py:WPS202,WPS204
    app/db/tasks/repo/task.py:WPS204
# Commented out code (not code) + magic numbers
    app/resources/templates/macros/declensions/numeral.py:WPS432,E800
# high module cognitive complexity
    app/settings/environments/base.py:WPS232,WPS115
    app/services/botx_user_search.py:WPS232
# line too long
    app/resources/strings.py:E501
    app/services/pagination/pagination.py:E501
# Protocol don't need to be implemented
    app/db/tasks/repo/mixins/handler.py:WPS428

no-accept-encodings = True
inline-quotes = "

# See https://wemake-python-stylegui.de/en/latest/pages/usage/violations/index.html
ignore =
    # black handles whitespace before ':'.
    E203,
    # also handled by black.
    C8,
    # asserts is OK.
    S101,
    # mako templates are used as messages, so no xss attacks.
    S702,
    # function calls in arguments definition is part of fastapi and botx di system.
    B008,
    # docstrings for public nested classes like Meta or Config not necessary
    D106,
    # empty lines after docstrings. handle by black
    D202, D207
    # return in docstrings is not required part
    DAR201,
    # Uppercase constant are OK (PEP8)
    WPS115,
    # f-strings are useful
    WPS305,
    # required base in class definition is strange
    WPS306,
    # objects that are returned from fastapi and botx as di system parts should be available
    WPS404,
    # does not play well with forward type references
    WPS226,
    # Forbids to use implicit string concatenation
    WPS326,
    # Docstrings for public method
    D103,
    # Docstrings for public class
    D101,

[darglint]
# See https://github.com/terrencepreilly/darglint#strictness-configuration
strictness = long
